<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>

    <script>
        osql.requireLogin();
        var name = osql.getParam('name');

        $().ready(function () {
            init();
            setInterval(showOhgiriRooms, 2000);
        });

        function init() {
            document.getElementById('welcome').innerHTML = `ようこそ${name}さん`;
        }

        async function showOhgiriRooms() {
            var sql = `select * from Ohgiri`
            var objects = await osql.connect(sql);

            var html = '';
            html = html + '<table border="1" style="border-collapse: collapse">';
            html = html + '<tr>';
            html = html + '<th>ルーム名</th><th>参加者数</th><th>レベル</th><th>お題作成者</th><th>回答者として参加</th><th>お題作成者として参加</th>';
            html = html + '</tr>';
            for (var i = 0; i < objects.length; i++) {
                html = html + '<tr>';
                var object = objects[i];
                html = html + '<td>' + object.name + '</td>';
                html = html + '<td>' + object.playernum + '人</td>';
                if (object.level == 1) {
                    var levelText = "初級者";
                } else if (object.level == 2) {
                    var levelText = "上級者";
                }
                html = html + '<td>' + levelText + '</td>';
                if (object.providerid == 0) {
                    var provider = 1; //　本当は１
                } else {
                    var provider = 1;
                }
                html = html + '<td>' + provider + '人</td>';
                if (object.playernum >= 100) {
                    html = html + '<td>' + '<button id=' + object.level + ' type="button" value=' + object.gameid + 'onclick="buttonAnsPressed(this.value,this.id)" disabled>回答者</button>' + '</td>';
                } else {
                    html = html + '<td>' + '<button id=' + object.level + ' type="button" value=' + object.gameid + 'onclick="buttonAnsPressed(this.value,this.id)">回答者</button>' + '</td>';
                }
                if (provider == 1) {
                    html = html + '<td>' + '<button id=' + object.level + ' type="button" value=' + object.gameid + 'onclick="buttonSubPressed(this.value,this.id)">お題作成者</button disabled>' + '</td>';
                } else {
                    html = html + '<td>' + '<button id=' + object.level + ' type="button" value=' + object.gameid + 'onclick="buttonSubPressed(this.value,this.id)">お題作成者</button disabled>' + '</td>';// 本当はdisabledない
                }


                html = html + '</tr>';
            }
            html = html + '</table>';
            document.getElementById('ohgiriTable').innerHTML = html;
        }

        async function buttonAnsPressed(gameid, level) { // 参加フォーム
            var me = await osql.getMe();

            var thisTable = `select * from Ohgiri where gameid = ${gameid}`;
            var tableInfo = await osql.connect(thisTable);

            var sql = `insert ignore into Players (userid, gameid, type) values ('${me.id}', ${gameid}, 1);`;
            await osql.connect(sql);
            var sqlcount = `update Ohgiri set playernum = playernum + 1 where gameid = ${gameid};`;
            await osql.connect(sqlcount);
            location.href = `waiting.html?gameid=${gameid}&type=1&level=${level}`;
        }

        // async function buttonSubPressed(gameid, level) { // 参加フォーム
        //     var me = await osql.getMe();

        //     var thisTable2 = `select * from Ohgiri where gameid = ${gameid}`;
        //     var tableInfo1 = await osql.connect(thisTable2);

        //     var sql = `insert ignore into Players (userid, gameid, type) values ('${me.id}', ${gameid}, 2);`;
        //     if (tableInfo1[0]["providerid"] == 0) {
        //         await osql.connect(sql);
        //         var sqlcount = `update Ohgiri set playernum = playernum + 1 where gameid = ${gameid};`;
        //         await osql.connect(sqlcount);
        //         var sqlprovider = `update Ohgiri set providerid = '${me.id}' where gameid = ${gameid};`;
        //         await osql.connect(sqlprovider);
        //         location.href = `waiting.html?gameid=${gameid}&type=2&level=${level}`;
        //     } else {
        //         window.alert("すでにお題作成者が参加しています。");
        //     }
        // }

        async function buttonCreationPressed() {
            var newRoom = document.forms['creation'].elements['createRoom'].value;
            var level = document.forms['creation'].elements['level'].value;
            console.log(newRoom);
            var sql = `insert into Ohgiri (name, providerid, playernum, level, subjectid) values ('${newRoom}', 0, 1, ${level}, 0);`;
            await osql.connect(sql);
        }

    </script>

</head>

<body>
    <h1>大喜利ルーム参加</h1>
    <p id="welcome">ようこそxxさん</p>
    <hr>
    <br>
    <p>ルーム新規作成</p>
    <form name="creation" method="post">
        <label for="your_name">グループの名前：</label>
        <input id="createRoom" name="createRoom" placeholder="名前を入力">
        <label><input type="radio" name="level" value=1 required checked>初級者</label>
        <label><input type="radio" name="level" value=2>上級者</label>
        <input type="submit" value="作成">
    </form>
    <br>
    <hr>
    <br>
    <div id="ohgiriTable"></div>
</body>

</html>